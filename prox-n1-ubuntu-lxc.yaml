- name: Install community.general Ansible Galaxy collectioncollection
  hosts: localhost
  tasks: 
    - name: Install community.general collection
      ansible.builtin.command: ansible-galaxy collection install community.general
      
- name: Proxmox LXC Cloning
  vars:
    container_name: ubuntu
    node_choice: "{{ NODE_CHOICE }}"
    clone_id: 100  # Default value
    proxmox_node: "node{{ node_choice | default(0) }}"
    api_host: "127.0.0.1"  # Default value
  hosts: localhost
  tasks:
    - name: Set variables based on node choice
      set_fact:
        clone_id: >-
          {% if node_choice == 1 %}
            104
          {% elif node_choice == 2 %}
            102
          {% elif node_choice == 3 %}
            101
          {% endif %}
        proxmox_node: "node{{ node_choice }}"
        api_host: >-
          {% if node_choice == 1 %}
            10.10.0.10
          {% elif node_choice == 2 %}
            10.10.0.20
          {% elif node_choice == 3 %}
            10.10.0.30
          {% endif %}

    - name: Add proxmox_node to temporary inventory
      add_host:
        name: "{{ proxmox_node }}"
        ansible_host: "{{ api_host }}"
      run_once: true

- name: Proxmox LXC Cloning
  hosts: localhost
  tasks:
    - name: Set proxmox_node variable for the second play
      set_fact:
        proxmox_node: "{{ proxmox_node }}"

- name: Proxmox LXC Cloning
  hosts: "{{ proxmox_node }}"
  tasks:
    - name: Determine Hostname
      set_fact:
        yeppers: "ubuntu-{{ lookup('password', '/dev/null chars=ascii_lowercase,digits length=8') }}"
        
    - name: Get existing LXC container IDs on NODE1
      shell: pct list | awk '{print $1}' || true
      register: existing_lxc_ids
      ignore_errors: true

    - name: Determine the next available LXC ID
      set_fact:
        next_lxc_id: "{{ existing_lxc_ids.stdout_lines | map('int') | max + 1 | default(100) }}"

    - name: Display the next available LXC IDnext_lxc_id
      debug:
        var: next_lxc_id

    - name: Clone LXC
      community.general.proxmox:
        vmid: "{{ next_lxc_id }}"
        node: "{{ proxmox_node }}"
        api_user: root@pam
        api_password: "{{ lookup('env', 'PASSWORD') }}"
        api_host: "{{ api_host }}"
        hostname: "{{ HOSTNAME_CHOICE }}"
        clone: "{{ clone_id }}"
        storage: local
        timeout: 180

    - name: Start LXC container
      community.general.proxmox:
        api_user: root@pam
        api_password: "{{ lookup('env', 'PASSWORD') }}"
        api_host: "{{ api_host }}"
        vmid: "{{ next_lxc_id }}"  # Use the variable created earlier
        node: "{{ proxmox_node }}"
        state: started

    - name: get LXC container ID
      shell: pct list | grep "{{ HOSTNAME_CHOICE }}" | awk '{ print $1 }'
      register: thelxcid

    - name: debug LXC container ID
      debug:
        var: thelxcid.stdout

    - name: Pause for 1 minute to build app cache
      ansible.builtin.pause:
        minutes: 1

    - name: get LXC container IP
      shell: pct exec "{{ next_lxc_id }}" -- ip a show dev eth0 | grep -oP 'inet \K\S+'
      register: theip

    - name: debug LXC container IP
      debug:
        var: theip.stdout

    - name: Slack Notification
      community.general.slack:
        token: "{{ lookup('env', 'TOKEN') }}"
        msg: |
          ### Your LXC Container is READY!! ###
          --------------------------------------
          `Container`: "{{ HOSTNAME_CHOICE }}"
          {% if theip is defined %}
          `IP ADDRESS`: "{{ theip.stdout }}"
          'URL': ssh://user@{{ theip.stdout }}
          {% else %}
          `IP ADDRESS`: Not available
          'URL': Not available
          {% endif %}
          --------------------------------------
        channel: '#ansible'
        color: good
        username: 'Ansible on {{ inventory_hostname }}'
        link_names: 0
        parse: 'none'
      ignore_errors: true
